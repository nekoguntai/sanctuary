name: Install Tests

on:
  push:
    branches:
      - main
    paths:
      - 'install.sh'
      - 'docker-compose.yml'
      - 'Dockerfile'
      - 'server/Dockerfile'
      - 'server/prisma/**'
      - 'docker/**'
      - 'tests/install/**'
      - '.github/workflows/install-test.yml'
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
    paths:
      - 'install.sh'
      - 'docker-compose.yml'
      - 'Dockerfile'
      - 'server/Dockerfile'
      - 'server/prisma/**'
      - 'docker/**'
      - 'tests/install/**'
      - '.github/workflows/install-test.yml'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - fresh-install
          - upgrade
          - container-health
          - auth-flow
          - release-critical
      keep_containers:
        description: 'Keep containers after test for debugging'
        required: false
        default: false
        type: boolean

env:
  HTTPS_PORT: 8443
  HTTP_PORT: 8080

jobs:
  # ============================================
  # Determine Test Scope
  # ============================================
  determine-scope:
    name: Determine Test Scope
    runs-on: ubuntu-latest
    outputs:
      is_release: ${{ steps.check.outputs.is_release }}
      test_suite: ${{ steps.check.outputs.test_suite }}
      run_upgrade: ${{ steps.check.outputs.run_upgrade }}
    steps:
      - name: Check trigger type
        id: check
        run: |
          # Check if this is a release tag
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "test_suite=release-critical" >> $GITHUB_OUTPUT
            echo "run_upgrade=false" >> $GITHUB_OUTPUT
            echo "Triggered by release tag: ${{ github.ref }}"
          elif [[ "${{ github.event.inputs.test_suite }}" != "" ]]; then
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "test_suite=${{ github.event.inputs.test_suite }}" >> $GITHUB_OUTPUT
            if [[ "${{ github.event.inputs.test_suite }}" == "all" || "${{ github.event.inputs.test_suite }}" == "upgrade" ]]; then
              echo "run_upgrade=true" >> $GITHUB_OUTPUT
            else
              echo "run_upgrade=false" >> $GITHUB_OUTPUT
            fi
            echo "Triggered manually with suite: ${{ github.event.inputs.test_suite }}"
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "test_suite=all" >> $GITHUB_OUTPUT
            echo "run_upgrade=false" >> $GITHUB_OUTPUT
            echo "Triggered by push/PR - running standard suite (excluding upgrade)"
          fi

  # ============================================
  # Unit Tests for install.sh
  # ============================================
  unit-tests:
    name: Install Script Unit Tests
    runs-on: ubuntu-latest
    needs: determine-scope
    if: |
      needs.determine-scope.outputs.test_suite == 'all' ||
      needs.determine-scope.outputs.test_suite == 'unit' ||
      needs.determine-scope.outputs.test_suite == 'release-critical'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make test scripts executable
        run: chmod +x tests/install/unit/*.sh tests/install/e2e/*.sh tests/install/utils/*.sh

      - name: Run unit tests
        run: ./tests/install/unit/install-script.test.sh

  # ============================================
  # Fresh Install E2E Test
  # ============================================
  fresh-install-test:
    name: Fresh Install E2E Test
    runs-on: ubuntu-latest
    needs: determine-scope
    if: |
      needs.determine-scope.outputs.test_suite == 'all' ||
      needs.determine-scope.outputs.test_suite == 'fresh-install' ||
      needs.determine-scope.outputs.test_suite == 'release-critical'
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check Docker
        run: |
          docker --version
          docker compose version

      - name: Make test scripts executable
        run: chmod +x tests/install/unit/*.sh tests/install/e2e/*.sh tests/install/utils/*.sh

      - name: Run fresh install test
        env:
          HTTPS_PORT: ${{ env.HTTPS_PORT }}
          HTTP_PORT: ${{ env.HTTP_PORT }}
        run: |
          if [ "${{ github.event.inputs.keep_containers }}" == "true" ]; then
            ./tests/install/e2e/fresh-install.test.sh --keep-containers --verbose
          else
            ./tests/install/e2e/fresh-install.test.sh --verbose
          fi

      - name: Show container logs on failure
        if: failure()
        run: |
          echo "=== Container Status ==="
          docker compose ps || true
          echo ""
          echo "=== Database Logs ==="
          docker compose logs --tail 100 postgres 2>&1 || true
          echo ""
          echo "=== Backend Logs ==="
          docker compose logs --tail 100 backend 2>&1 || true
          echo ""
          echo "=== Frontend Logs ==="
          docker compose logs --tail 100 frontend 2>&1 || true
          echo ""
          echo "=== Gateway Logs ==="
          docker compose logs --tail 100 gateway 2>&1 || true
          echo ""
          echo "=== Migration Logs ==="
          docker compose logs migrate 2>&1 || true

      - name: Cleanup
        if: always() && github.event.inputs.keep_containers != 'true'
        run: |
          docker compose down -v --remove-orphans || true
          docker system prune -f || true

  # ============================================
  # Container Health Test
  # ============================================
  container-health-test:
    name: Container Health Test
    runs-on: ubuntu-latest
    needs: [determine-scope, fresh-install-test]
    if: |
      always() &&
      needs.fresh-install-test.result == 'success' &&
      (needs.determine-scope.outputs.test_suite == 'all' ||
       needs.determine-scope.outputs.test_suite == 'container-health' ||
       needs.determine-scope.outputs.test_suite == 'release-critical')
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Make test scripts executable
        run: chmod +x tests/install/unit/*.sh tests/install/e2e/*.sh tests/install/utils/*.sh

      - name: Start containers
        env:
          HTTPS_PORT: ${{ env.HTTPS_PORT }}
          HTTP_PORT: ${{ env.HTTP_PORT }}
        run: |
          # Generate all 4 required secrets
          JWT_SECRET=$(openssl rand -base64 32 | tr -d '=/+' | head -c 48)
          ENCRYPTION_KEY=$(openssl rand -base64 32 | tr -d '=/+' | head -c 48)
          GATEWAY_SECRET=$(openssl rand -base64 32 | tr -d '=/+' | head -c 48)
          POSTGRES_PASSWORD=$(openssl rand -base64 16 | tr -d '=/+' | head -c 24)

          # Generate SSL certs
          cd docker/nginx/ssl && ./generate-certs.sh localhost && cd ../../..

          # Start containers
          JWT_SECRET="$JWT_SECRET" ENCRYPTION_KEY="$ENCRYPTION_KEY" \
            GATEWAY_SECRET="$GATEWAY_SECRET" POSTGRES_PASSWORD="$POSTGRES_PASSWORD" \
            HTTPS_PORT=$HTTPS_PORT HTTP_PORT=$HTTP_PORT \
            docker compose up -d --build

          # Wait for startup
          sleep 30

      - name: Run container health tests
        env:
          HTTPS_PORT: ${{ env.HTTPS_PORT }}
        run: ./tests/install/e2e/container-health.test.sh --verbose

      - name: Show container logs on failure
        if: failure()
        run: |
          docker compose ps || true
          docker compose logs --tail 50 postgres 2>&1 || true
          docker compose logs --tail 50 backend 2>&1 || true
          docker compose logs --tail 50 frontend 2>&1 || true

      - name: Cleanup
        if: always()
        run: docker compose down -v --remove-orphans || true

  # ============================================
  # Authentication Flow Test
  # ============================================
  auth-flow-test:
    name: Authentication Flow Test
    runs-on: ubuntu-latest
    needs: [determine-scope, fresh-install-test]
    if: |
      always() &&
      needs.fresh-install-test.result == 'success' &&
      (needs.determine-scope.outputs.test_suite == 'all' ||
       needs.determine-scope.outputs.test_suite == 'auth-flow' ||
       needs.determine-scope.outputs.test_suite == 'release-critical')
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Make test scripts executable
        run: chmod +x tests/install/unit/*.sh tests/install/e2e/*.sh tests/install/utils/*.sh

      - name: Start containers
        env:
          HTTPS_PORT: ${{ env.HTTPS_PORT }}
          HTTP_PORT: ${{ env.HTTP_PORT }}
        run: |
          # Generate all 4 required secrets
          JWT_SECRET=$(openssl rand -base64 32 | tr -d '=/+' | head -c 48)
          ENCRYPTION_KEY=$(openssl rand -base64 32 | tr -d '=/+' | head -c 48)
          GATEWAY_SECRET=$(openssl rand -base64 32 | tr -d '=/+' | head -c 48)
          POSTGRES_PASSWORD=$(openssl rand -base64 16 | tr -d '=/+' | head -c 24)

          # Generate SSL certs
          cd docker/nginx/ssl && ./generate-certs.sh localhost && cd ../../..

          # Start containers with higher rate limits for testing
          JWT_SECRET="$JWT_SECRET" ENCRYPTION_KEY="$ENCRYPTION_KEY" \
            GATEWAY_SECRET="$GATEWAY_SECRET" POSTGRES_PASSWORD="$POSTGRES_PASSWORD" \
            HTTPS_PORT=$HTTPS_PORT HTTP_PORT=$HTTP_PORT \
            LOGIN_RATE_LIMIT=100 PASSWORD_CHANGE_RATE_LIMIT=100 \
            docker compose up -d --build

          # Wait for migration to complete
          timeout 120 bash -c 'until docker compose ps migrate --format "{{.Status}}" 2>/dev/null | grep -q "Exited"; do sleep 5; done' || true

          # Wait for services
          sleep 30

      - name: Run auth flow tests
        env:
          HTTPS_PORT: ${{ env.HTTPS_PORT }}
        run: ./tests/install/e2e/auth-flow.test.sh --verbose

      - name: Show container logs on failure
        if: failure()
        run: |
          docker compose ps || true
          docker compose logs --tail 100 backend 2>&1 || true

      - name: Cleanup
        if: always()
        run: docker compose down -v --remove-orphans || true

  # ============================================
  # Upgrade Test (Optional - Long Running)
  # ============================================
  upgrade-test:
    name: Upgrade Install Test
    runs-on: ubuntu-latest
    needs: determine-scope
    if: |
      needs.determine-scope.outputs.run_upgrade == 'true' ||
      needs.determine-scope.outputs.test_suite == 'upgrade'
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Make test scripts executable
        run: chmod +x tests/install/unit/*.sh tests/install/e2e/*.sh tests/install/utils/*.sh

      - name: Run upgrade test
        env:
          HTTPS_PORT: ${{ env.HTTPS_PORT }}
          HTTP_PORT: ${{ env.HTTP_PORT }}
        run: ./tests/install/e2e/upgrade-install.test.sh --verbose

      - name: Show container logs on failure
        if: failure()
        run: |
          docker compose ps || true
          docker compose logs --tail 50 postgres 2>&1 || true
          docker compose logs --tail 100 backend 2>&1 || true

      - name: Cleanup
        if: always()
        run: docker compose down -v --remove-orphans || true

  # ============================================
  # Test Summary
  # ============================================
  test-summary:
    name: Install Test Summary
    runs-on: ubuntu-latest
    needs: [determine-scope, unit-tests, fresh-install-test, container-health-test, auth-flow-test, upgrade-test]
    if: always()

    steps:
      - name: Generate summary
        env:
          IS_RELEASE: ${{ needs.determine-scope.outputs.is_release }}
          TEST_SUITE: ${{ needs.determine-scope.outputs.test_suite }}
        run: |
          echo "## Install Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show test context
          if [ "$IS_RELEASE" == "true" ]; then
            echo "### Release Validation: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> Running release-critical tests to validate installation before release." >> $GITHUB_STEP_SUMMARY
          else
            echo "### Test Suite: $TEST_SUITE" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Unit tests
          if [ "${{ needs.unit-tests.result }}" == "success" ]; then
            echo "- Unit Tests: :white_check_mark: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.unit-tests.result }}" == "skipped" ]; then
            echo "- Unit Tests: :arrow_right: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Unit Tests: :x: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Fresh install
          if [ "${{ needs.fresh-install-test.result }}" == "success" ]; then
            echo "- Fresh Install E2E: :white_check_mark: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.fresh-install-test.result }}" == "skipped" ]; then
            echo "- Fresh Install E2E: :arrow_right: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Fresh Install E2E: :x: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Container health
          if [ "${{ needs.container-health-test.result }}" == "success" ]; then
            echo "- Container Health: :white_check_mark: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.container-health-test.result }}" == "skipped" ]; then
            echo "- Container Health: :arrow_right: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Container Health: :x: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Auth flow
          if [ "${{ needs.auth-flow-test.result }}" == "success" ]; then
            echo "- Auth Flow: :white_check_mark: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.auth-flow-test.result }}" == "skipped" ]; then
            echo "- Auth Flow: :arrow_right: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Auth Flow: :x: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Upgrade test
          if [ "${{ needs.upgrade-test.result }}" == "success" ]; then
            echo "- Upgrade Install: :white_check_mark: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.upgrade-test.result }}" == "skipped" ]; then
            echo "- Upgrade Install: :arrow_right: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Upgrade Install: :x: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- HTTPS Port: ${{ env.HTTPS_PORT }}" >> $GITHUB_STEP_SUMMARY
          echo "- HTTP Port: ${{ env.HTTP_PORT }}" >> $GITHUB_STEP_SUMMARY

          # Release gate warning
          if [ "$IS_RELEASE" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.unit-tests.result }}" == "success" ] && \
               [ "${{ needs.fresh-install-test.result }}" == "success" ] && \
               [ "${{ needs.container-health-test.result }}" == "success" ] && \
               [ "${{ needs.auth-flow-test.result }}" == "success" ]; then
              echo ":rocket: **Release validation passed!** Installation has been verified." >> $GITHUB_STEP_SUMMARY
            else
              echo ":stop_sign: **Release validation FAILED!** Do not proceed with release until issues are resolved." >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Check release gate
        if: needs.determine-scope.outputs.is_release == 'true'
        run: |
          echo "Checking release gate..."

          FAILED=false

          if [ "${{ needs.unit-tests.result }}" != "success" ] && [ "${{ needs.unit-tests.result }}" != "skipped" ]; then
            echo "::error::Unit tests failed - release blocked"
            FAILED=true
          fi

          if [ "${{ needs.fresh-install-test.result }}" != "success" ]; then
            echo "::error::Fresh install test failed - release blocked"
            FAILED=true
          fi

          if [ "${{ needs.container-health-test.result }}" != "success" ] && [ "${{ needs.container-health-test.result }}" != "skipped" ]; then
            echo "::error::Container health test failed - release blocked"
            FAILED=true
          fi

          if [ "${{ needs.auth-flow-test.result }}" != "success" ] && [ "${{ needs.auth-flow-test.result }}" != "skipped" ]; then
            echo "::error::Auth flow test failed - release blocked"
            FAILED=true
          fi

          if [ "$FAILED" == "true" ]; then
            echo "::error::Release validation failed! Install tests must pass before releasing."
            exit 1
          fi

          echo "Release validation passed!"
