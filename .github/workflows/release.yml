name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.4.2)'
        required: true
        type: string
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  # This job runs on push to provide a successful status check
  check:
    name: Release Check
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Skip
        run: echo "Release workflow skipped for push events"

  # ============================================
  # Validate Release Candidate
  # ============================================
  validate-release-candidate:
    name: Validate Release Candidate
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need parent commit

      - name: Get commit SHA and parent
        id: get-sha
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            # For release events, get the SHA of the tagged commit
            SHA="${{ github.event.release.target_commitish }}"
            # If target_commitish is a branch name, resolve to SHA
            if [[ ! "$SHA" =~ ^[0-9a-f]{40}$ ]]; then
              SHA="${{ github.sha }}"
            fi
          else
            SHA="${{ github.sha }}"
          fi
          # Get parent commit SHA (for version bump commits)
          PARENT_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "")
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "parent_sha=$PARENT_SHA" >> $GITHUB_OUTPUT
          echo "Validating release for commit: $SHA"
          echo "Parent commit: $PARENT_SHA"

      - name: Check for successful Release Candidate run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for successful Release Candidate Validation workflow run..."
          echo ""

          COMMIT_SHA="${{ steps.get-sha.outputs.sha }}"
          PARENT_SHA="${{ steps.get-sha.outputs.parent_sha }}"

          # Check current commit first
          RUNS=$(gh api repos/${{ github.repository }}/actions/workflows/release-candidate.yml/runs \
            --jq ".workflow_runs[] | select(.head_sha == \"$COMMIT_SHA\" and .conclusion == \"success\") | {id: .id, created_at: .created_at, conclusion: .conclusion}" \
            2>/dev/null || echo "")

          if [ -n "$RUNS" ] && [ "$RUNS" != "" ]; then
            echo "‚úì Found successful Release Candidate Validation run for commit $COMMIT_SHA:"
            echo "$RUNS" | head -1
            echo ""
            echo "Release validation passed. Proceeding with release..."
            exit 0
          fi

          # If not found, check parent commit (for version bump commits)
          if [ -n "$PARENT_SHA" ]; then
            echo "No validation for current commit, checking parent commit $PARENT_SHA..."
            PARENT_RUNS=$(gh api repos/${{ github.repository }}/actions/workflows/release-candidate.yml/runs \
              --jq ".workflow_runs[] | select(.head_sha == \"$PARENT_SHA\" and .conclusion == \"success\") | {id: .id, created_at: .created_at, conclusion: .conclusion}" \
              2>/dev/null || echo "")

            if [ -n "$PARENT_RUNS" ] && [ "$PARENT_RUNS" != "" ]; then
              echo "‚úì Found successful Release Candidate Validation run for parent commit $PARENT_SHA:"
              echo "$PARENT_RUNS" | head -1
              echo ""
              echo "Release validation passed (via parent commit). Proceeding with release..."
              exit 0
            fi
          fi

          echo "::error::No successful Release Candidate Validation found for commit $COMMIT_SHA or its parent"
          echo ""
          echo "=========================================="
          echo "RELEASE BLOCKED"
          echo "=========================================="
          echo ""
          echo "Before releasing, you must:"
          echo "1. Run the 'Release Candidate Validation' workflow on this commit"
          echo "2. Wait for ALL tests to pass (including upgrade tests)"
          echo "3. Then retry the release"
          echo ""
          echo "To run Release Candidate Validation:"
          echo "  gh workflow run release-candidate.yml --field ref=$COMMIT_SHA"
          echo ""
          echo "Or via GitHub UI: Actions > Release Candidate Validation > Run workflow"
          echo ""
          exit 1

  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: validate-release-candidate
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
      packages: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      frontend_digest: ${{ steps.frontend.outputs.digest }}
      backend_digest: ${{ steps.backend.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          else
            VERSION="${{ inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Frontend
        id: frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:v${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Backend
        id: backend
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:v${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  update-umbrel:
    name: Update Umbrel Package
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Umbrel package files
        run: |
          VERSION="${{ needs.build-and-push.outputs.version }}"
          FRONTEND_DIGEST="${{ needs.build-and-push.outputs.frontend_digest }}"
          BACKEND_DIGEST="${{ needs.build-and-push.outputs.backend_digest }}"

          echo "Updating Umbrel package to v$VERSION"
          echo "Frontend digest: $FRONTEND_DIGEST"
          echo "Backend digest: $BACKEND_DIGEST"

          # Update umbrel-app.yml version
          sed -i "s/^version: .*/version: \"$VERSION\"/" sanctuary/umbrel-app.yml

          # Update releaseNotes in umbrel-app.yml
          RELEASE_DATE=$(date +"%Y-%m-%d")
          sed -i "s/^releaseNotes: .*/releaseNotes: \"Version $VERSION released on $RELEASE_DATE. See https:\/\/github.com\/n-narusegawa\/sanctuary\/releases\/tag\/v$VERSION for details.\"/" sanctuary/umbrel-app.yml

          # Update docker-compose.yml with new image tags and digests
          # Handle both with and without existing @sha256 suffix
          sed -i "s|ghcr.io/n-narusegawa/sanctuary-frontend:[^[:space:]]*|ghcr.io/n-narusegawa/sanctuary-frontend:v$VERSION@$FRONTEND_DIGEST|g" sanctuary/docker-compose.yml
          sed -i "s|ghcr.io/n-narusegawa/sanctuary-backend:[^[:space:]]*|ghcr.io/n-narusegawa/sanctuary-backend:v$VERSION@$BACKEND_DIGEST|g" sanctuary/docker-compose.yml

          echo "Updated files:"
          grep -E "version:|releaseNotes:" sanctuary/umbrel-app.yml
          grep "image:" sanctuary/docker-compose.yml

      - name: Commit and push Umbrel updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add sanctuary/
          git diff --staged --quiet || git commit -m "Update Umbrel package to v${{ needs.build-and-push.outputs.version }}

          - Updated Docker image tags with SHA256 digests
          - Updated release notes

          ü§ñ Automated release update"
          git push

  update-release:
    name: Update Release Notes
    needs: [build-and-push, update-umbrel]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update release notes with install instructions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.build-and-push.outputs.version }}
          RELEASE_ID: ${{ github.event.release.id }}
        run: |
          # Get existing release body
          EXISTING_BODY=$(gh api repos/${{ github.repository }}/releases/$RELEASE_ID --jq '.body // ""')

          # Create install instructions
          INSTALL_INSTRUCTIONS="## Quick Install

          **Prerequisites:** Docker and Git

          \`\`\`bash
          git clone https://github.com/n-narusegawa/sanctuary.git
          cd sanctuary
          ./install.sh
          \`\`\`

          Open https://localhost:8443 and log in with admin / sanctuary

          ---

          ## Upgrading

          \`\`\`bash
          cd sanctuary
          git pull
          ./install.sh
          \`\`\`

          ---

          ## Umbrel Installation

          > ‚ö†Ô∏è **Limited Functionality:** Umbrel serves apps over HTTP (not HTTPS), which means **WebUSB hardware wallet connections will not work**. You can still use Sanctuary on Umbrel for importing wallets via descriptors, viewing balances/history, and creating unsigned PSBTs for air-gapped signing. For full hardware wallet USB support, use the Quick Install method above.

          1. Open the App Store in your Umbrel
          2. Click the ... menu in the upper right
          3. Select Community App Stores
          4. Paste: https://github.com/n-narusegawa/sanctuary
          5. Click Add
          6. Find Sanctuary and install

          ---

          "

          # Combine and update
          if [ -n "$EXISTING_BODY" ]; then
            NEW_BODY="${INSTALL_INSTRUCTIONS}

          ## What's New

          ${EXISTING_BODY}"
          else
            NEW_BODY="$INSTALL_INSTRUCTIONS"
          fi

          gh release edit "v$VERSION" --notes "$NEW_BODY"
          echo "Updated release notes"
