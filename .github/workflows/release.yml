name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.4.2)'
        required: true
        type: string
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  # This job runs on push to provide a successful status check
  check:
    name: Release Check
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Skip
        run: echo "Release workflow skipped for push events"

  # ============================================
  # Validate Release Candidate
  # ============================================
  validate-release-candidate:
    name: Validate Release Candidate
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 10  # Need recent ancestors

      - name: Get commit SHA
        id: get-sha
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            SHA="${{ github.event.release.target_commitish }}"
            if [[ ! "$SHA" =~ ^[0-9a-f]{40}$ ]]; then
              SHA="${{ github.sha }}"
            fi
          else
            SHA="${{ github.sha }}"
          fi
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "Validating release for commit: $SHA"

      - name: Check for successful Release Candidate run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for successful Release Candidate Validation..."
          echo ""

          COMMIT_SHA="${{ steps.get-sha.outputs.sha }}"

          # Check current commit and up to 5 ancestors
          # This handles version bump commits and minor fixes after RC validation
          for i in 0 1 2 3 4 5; do
            if [ $i -eq 0 ]; then
              CHECK_SHA="$COMMIT_SHA"
              echo "Checking current commit: $CHECK_SHA"
            else
              CHECK_SHA=$(git rev-parse HEAD~$i 2>/dev/null || echo "")
              if [ -z "$CHECK_SHA" ]; then
                break
              fi
              echo "Checking ancestor ~$i: $CHECK_SHA"
            fi

            RUNS=$(gh api repos/${{ github.repository }}/actions/workflows/release-candidate.yml/runs \
              --jq ".workflow_runs[] | select(.head_sha == \"$CHECK_SHA\" and .conclusion == \"success\") | {id: .id, created_at: .created_at}" \
              2>/dev/null || echo "")

            if [ -n "$RUNS" ] && [ "$RUNS" != "" ]; then
              echo ""
              echo "‚úì Found successful Release Candidate Validation:"
              echo "  Commit: $CHECK_SHA"
              echo "  $RUNS" | head -1
              echo ""
              echo "Release validation passed. Proceeding with release..."
              exit 0
            fi
          done

          echo ""
          echo "::error::No successful Release Candidate Validation found in recent commits"
          echo ""
          echo "=========================================="
          echo "RELEASE BLOCKED"
          echo "=========================================="
          echo ""
          echo "Before releasing, you must:"
          echo "1. Run the 'Release Candidate Validation' workflow"
          echo "2. Wait for ALL tests to pass"
          echo "3. Then retry the release"
          echo ""
          echo "To run Release Candidate Validation:"
          echo "  gh workflow run release-candidate.yml --field ref=main"
          echo ""
          exit 1

  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: validate-release-candidate
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
      packages: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      frontend_digest: ${{ steps.frontend.outputs.digest }}
      backend_digest: ${{ steps.backend.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          else
            VERSION="${{ inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Frontend
        id: frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:v${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Backend
        id: backend
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:v${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  update-umbrel:
    name: Update Umbrel Package
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Umbrel package files
        run: |
          VERSION="${{ needs.build-and-push.outputs.version }}"
          FRONTEND_DIGEST="${{ needs.build-and-push.outputs.frontend_digest }}"
          BACKEND_DIGEST="${{ needs.build-and-push.outputs.backend_digest }}"

          echo "Updating Umbrel package to v$VERSION"
          echo "Frontend digest: $FRONTEND_DIGEST"
          echo "Backend digest: $BACKEND_DIGEST"

          # Update umbrel-app.yml version
          sed -i "s/^version: .*/version: \"$VERSION\"/" sanctuary/umbrel-app.yml

          # Update releaseNotes in umbrel-app.yml
          RELEASE_DATE=$(date +"%Y-%m-%d")
          sed -i "s/^releaseNotes: .*/releaseNotes: \"Version $VERSION released on $RELEASE_DATE. See https:\/\/github.com\/n-narusegawa\/sanctuary\/releases\/tag\/v$VERSION for details.\"/" sanctuary/umbrel-app.yml

          # Update docker-compose.yml with new image tags and digests
          # Handle both with and without existing @sha256 suffix
          sed -i "s|ghcr.io/n-narusegawa/sanctuary-frontend:[^[:space:]]*|ghcr.io/n-narusegawa/sanctuary-frontend:v$VERSION@$FRONTEND_DIGEST|g" sanctuary/docker-compose.yml
          sed -i "s|ghcr.io/n-narusegawa/sanctuary-backend:[^[:space:]]*|ghcr.io/n-narusegawa/sanctuary-backend:v$VERSION@$BACKEND_DIGEST|g" sanctuary/docker-compose.yml

          echo "Updated files:"
          grep -E "version:|releaseNotes:" sanctuary/umbrel-app.yml
          grep "image:" sanctuary/docker-compose.yml

      - name: Commit and push Umbrel updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add sanctuary/
          git diff --staged --quiet || git commit -m "Update Umbrel package to v${{ needs.build-and-push.outputs.version }}

          - Updated Docker image tags with SHA256 digests
          - Updated release notes

          ü§ñ Automated release update"
          git push

  update-release:
    name: Update Release Notes
    needs: [build-and-push, update-umbrel]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update release notes with install instructions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.build-and-push.outputs.version }}
          RELEASE_ID: ${{ github.event.release.id }}
        run: |
          # Get existing release body
          EXISTING_BODY=$(gh api repos/${{ github.repository }}/releases/$RELEASE_ID --jq '.body // ""')

          # Check if install instructions already exist (avoid duplication)
          if echo "$EXISTING_BODY" | grep -q "## Quick Install"; then
            echo "Install instructions already present, skipping update"
            exit 0
          fi

          # Create install instructions file to avoid heredoc issues
          cat > /tmp/install_instructions.md << 'INSTRUCTIONS'
## Quick Install

**Prerequisites:** Docker and Docker Compose

```bash
git clone https://github.com/n-narusegawa/sanctuary.git
cd sanctuary
./install.sh
```

Open **https://localhost:8443** and log in with:
- **Username:** `admin`
- **Password:** `sanctuary`

> ‚ö†Ô∏è Change these credentials immediately after first login.

---

## Upgrading

Your data and configuration will be preserved automatically.

```bash
cd sanctuary
git pull
./install.sh
```

The install script handles database migrations and restarts services.

---

<details>
<summary><strong>Umbrel Installation</strong> (alternative method)</summary>

> **Note:** Umbrel serves apps over HTTP, so WebUSB hardware wallet connections will not work. Use the Quick Install method above for full hardware wallet support.

1. Open the App Store in your Umbrel
2. Click the **...** menu and select **Community App Stores**
3. Paste: `https://github.com/n-narusegawa/sanctuary`
4. Click **Add**, then find Sanctuary and install

</details>

---

INSTRUCTIONS

          # Build final release body
          if [ -n "$EXISTING_BODY" ]; then
            cat /tmp/install_instructions.md > /tmp/release_body.md
            echo -e "\n## What's New\n" >> /tmp/release_body.md
            echo "$EXISTING_BODY" >> /tmp/release_body.md
          else
            cat /tmp/install_instructions.md > /tmp/release_body.md
          fi

          gh release edit "v$VERSION" --notes-file /tmp/release_body.md
          echo "Updated release notes"
