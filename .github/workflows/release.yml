name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.4.2)'
        required: true
        type: string
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  # This job runs on push to provide a successful status check
  check:
    name: Release Check
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Skip
        run: echo "Release workflow skipped for push events"

  # ============================================
  # Wait for Install Tests to Pass
  # ============================================
  wait-for-install-tests:
    name: Wait for Install Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Wait for Install Tests workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CHECK_NAME="Install Test Summary"
          MAX_ATTEMPTS=60  # 30 minutes at 30-second intervals
          ATTEMPT=0

          echo "Waiting for '$CHECK_NAME' check to complete on ${{ github.sha }}..."

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))

            # Query for the check run
            RESULT=$(gh api repos/${{ github.repository }}/commits/${{ github.sha }}/check-runs \
              --jq ".check_runs[] | select(.name == \"$CHECK_NAME\") | {status: .status, conclusion: .conclusion}" 2>/dev/null || echo "{}")

            STATUS=$(echo "$RESULT" | jq -r '.status // "not_found"')
            CONCLUSION=$(echo "$RESULT" | jq -r '.conclusion // "null"')

            if [ "$STATUS" == "not_found" ] || [ "$STATUS" == "null" ]; then
              echo "[$ATTEMPT/$MAX_ATTEMPTS] Check '$CHECK_NAME' not found yet, waiting..."
            elif [ "$STATUS" == "completed" ]; then
              if [ "$CONCLUSION" == "success" ]; then
                echo "âœ“ Install tests passed!"
                exit 0
              else
                echo "âœ— Install tests failed with conclusion: $CONCLUSION"
                exit 1
              fi
            else
              echo "[$ATTEMPT/$MAX_ATTEMPTS] Check status: $STATUS, waiting..."
            fi

            sleep 30
          done

          echo "âœ— Timed out waiting for Install Test Summary after 30 minutes"
          exit 1

  # ============================================
  # Run Release Candidate Validation
  # ============================================
  release-candidate:
    name: Release Candidate
    needs: wait-for-install-tests
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/release-candidate.yml
    with:
      ref: ${{ github.sha }}
      version: ${{ github.event.release.tag_name || inputs.version }}

  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: release-candidate
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
      packages: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      frontend_digest: ${{ steps.frontend.outputs.digest }}
      backend_digest: ${{ steps.backend.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          else
            VERSION="${{ inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Frontend
        id: frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:v${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Backend
        id: backend
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:v${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  update-umbrel:
    name: Update Umbrel Package
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Umbrel package files
        run: |
          VERSION="${{ needs.build-and-push.outputs.version }}"
          FRONTEND_DIGEST="${{ needs.build-and-push.outputs.frontend_digest }}"
          BACKEND_DIGEST="${{ needs.build-and-push.outputs.backend_digest }}"

          echo "Updating Umbrel package to v$VERSION"
          echo "Frontend digest: $FRONTEND_DIGEST"
          echo "Backend digest: $BACKEND_DIGEST"

          # Update umbrel-app.yml version
          sed -i "s/^version: .*/version: \"$VERSION\"/" sanctuary/umbrel-app.yml

          # Update releaseNotes in umbrel-app.yml
          RELEASE_DATE=$(date +"%Y-%m-%d")
          sed -i "s/^releaseNotes: .*/releaseNotes: \"Version $VERSION released on $RELEASE_DATE. See https:\/\/github.com\/n-narusegawa\/sanctuary\/releases\/tag\/v$VERSION for details.\"/" sanctuary/umbrel-app.yml

          # Update docker-compose.yml with new image tags and digests
          # Handle both with and without existing @sha256 suffix
          sed -i "s|ghcr.io/n-narusegawa/sanctuary-frontend:[^[:space:]]*|ghcr.io/n-narusegawa/sanctuary-frontend:v$VERSION@$FRONTEND_DIGEST|g" sanctuary/docker-compose.yml
          sed -i "s|ghcr.io/n-narusegawa/sanctuary-backend:[^[:space:]]*|ghcr.io/n-narusegawa/sanctuary-backend:v$VERSION@$BACKEND_DIGEST|g" sanctuary/docker-compose.yml

          echo "Updated files:"
          grep -E "version:|releaseNotes:" sanctuary/umbrel-app.yml
          grep "image:" sanctuary/docker-compose.yml

      - name: Commit and push Umbrel updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add sanctuary/
          git diff --staged --quiet || git commit -m "Update Umbrel package to v${{ needs.build-and-push.outputs.version }}

          - Updated Docker image tags with SHA256 digests
          - Updated release notes

          ðŸ¤– Automated release update"
          git push

  update-release:
    name: Update Release Notes
    needs: [build-and-push, update-umbrel]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update release notes with install instructions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.build-and-push.outputs.version }}
          RELEASE_ID: ${{ github.event.release.id }}
        run: |
          # Get existing release body
          EXISTING_BODY=$(gh api repos/${{ github.repository }}/releases/$RELEASE_ID --jq '.body // ""')

          # Check if install instructions already exist (avoid duplication)
          if echo "$EXISTING_BODY" | grep -q "## Quick Install"; then
            echo "Install instructions already present, skipping update"
            exit 0
          fi

          # Create install instructions file
          cat > /tmp/install_instructions.md << 'EOF'
          ## Quick Install

          **Prerequisites:** Docker and Docker Compose

          ```bash
          git clone https://github.com/n-narusegawa/sanctuary.git
          cd sanctuary
          ./install.sh
          ```

          Open **https://localhost:8443** and log in with:
          - **Username:** `admin`
          - **Password:** `sanctuary`

          > Change these credentials immediately after first login.

          ---

          ## Upgrading

          Your data and configuration will be preserved automatically.

          ```bash
          cd sanctuary
          git pull
          ./install.sh
          ```

          The install script handles database migrations and restarts services.

          ---

          <details>
          <summary><strong>Umbrel Installation</strong> (alternative method)</summary>

          > **Note:** Umbrel serves apps over HTTP, so WebUSB hardware wallet connections will not work. Use the Quick Install method above for full hardware wallet support.

          1. Open the App Store in your Umbrel
          2. Click the **...** menu and select **Community App Stores**
          3. Paste: `https://github.com/n-narusegawa/sanctuary`
          4. Click **Add**, then find Sanctuary and install

          </details>

          ---
          EOF
          # Remove leading spaces from heredoc content
          sed -i 's/^          //' /tmp/install_instructions.md

          # Build final release body
          if [ -n "$EXISTING_BODY" ]; then
            cat /tmp/install_instructions.md > /tmp/release_body.md
            echo -e "\n## What's New\n" >> /tmp/release_body.md
            echo "$EXISTING_BODY" >> /tmp/release_body.md
          else
            cat /tmp/install_instructions.md > /tmp/release_body.md
          fi

          gh release edit "v$VERSION" --notes-file /tmp/release_body.md
          echo "Updated release notes"
