name: Verify Bitcoin Vectors

on:
  # Run weekly to catch any regressions
  schedule:
    - cron: '0 0 * * 0' # Every Sunday at midnight UTC

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      regenerate_psbt:
        description: 'Regenerate PSBT vectors with Bitcoin Core'
        required: false
        default: false
        type: boolean

  # Run on PRs that touch address derivation or PSBT code
  pull_request:
    paths:
      - 'server/src/services/bitcoin/addressDerivation.ts'
      - 'server/src/services/bitcoin/descriptorParser.ts'
      - 'server/src/services/scriptTypes/**'
      - 'server/tests/fixtures/verified-address-vectors.ts'
      - 'server/tests/fixtures/bip174-test-vectors.ts'
      - 'scripts/verify-addresses/**'
      - 'scripts/verify-psbt/**'

jobs:
  verify-vectors:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install server dependencies
        working-directory: server
        run: npm ci

      - name: Run address derivation tests
        working-directory: server
        run: npm run test -- tests/unit/services/bitcoin/addressDerivation.verified.test.ts

      - name: Run derivation path tests
        working-directory: server
        run: npm run test -- tests/unit/services/scriptTypes/derivationPaths.test.ts

      - name: Run multisig key ordering tests
        working-directory: server
        run: npm run test -- tests/unit/services/bitcoin/multisigKeyOrdering.test.ts

      - name: Run xpub validation tests
        working-directory: server
        run: npm run test -- tests/unit/services/bitcoin/xpubValidation.test.ts

      - name: Run property-based tests
        working-directory: server
        run: npm run test -- tests/unit/services/bitcoin/propertyBased.test.ts

      - name: Run descriptor checksum tests
        working-directory: server
        run: npm run test -- tests/unit/services/bitcoin/descriptorChecksum.test.ts

      - name: Run PSBT BIP-174 verification tests
        working-directory: server
        run: npm run test -- tests/unit/services/bitcoin/psbt.verified.test.ts

      - name: Run PSBT property-based tests
        working-directory: server
        run: npm run test -- tests/unit/services/bitcoin/psbt.property.test.ts

  # Optional: Regenerate vectors with Bitcoin Core
  # This job runs only on manual trigger and requires Docker
  regenerate-vectors:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    services:
      bitcoind:
        image: ruimarinho/bitcoin-core:latest
        ports:
          - 18443:18443
        options: >-
          --health-cmd "bitcoin-cli -regtest -rpcuser=test -rpcpassword=test getblockchaininfo"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install verification script dependencies
        working-directory: scripts/verify-addresses
        run: npm ci
        continue-on-error: true # May not exist yet

      - name: Generate vectors with Bitcoin Core
        working-directory: scripts/verify-addresses
        run: |
          echo "Vector generation would run here"
          echo "This requires the verify-addresses infrastructure to be set up"
        continue-on-error: true

      - name: Check for vector changes
        run: |
          if git diff --quiet server/tests/fixtures/verified-address-vectors.ts; then
            echo "âœ… Vectors unchanged - all implementations agree"
          else
            echo "âš ï¸ Vectors changed - review needed"
            git diff server/tests/fixtures/verified-address-vectors.ts
            exit 1
          fi
        continue-on-error: true

  # Optional: Regenerate PSBT vectors with Bitcoin Core
  regenerate-psbt-vectors:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.regenerate_psbt == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    services:
      bitcoind:
        image: ruimarinho/bitcoin-core:27
        ports:
          - 18443:18443
        options: >-
          --health-cmd "bitcoin-cli -regtest -rpcuser=sanctuary -rpcpassword=sanctuary-verify getblockchaininfo"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
        env:
          BITCOIN_ARGS: "-regtest -server -rpcuser=sanctuary -rpcpassword=sanctuary-verify -rpcallowip=0.0.0.0/0 -rpcbind=0.0.0.0 -fallbackfee=0.00001"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Wait for Bitcoin Core
        run: |
          echo "Waiting for Bitcoin Core to be ready..."
          for i in {1..30}; do
            if curl -s --user sanctuary:sanctuary-verify --data-binary '{"jsonrpc":"1.0","method":"getblockchaininfo","params":[]}' http://localhost:18443/ > /dev/null 2>&1; then
              echo "Bitcoin Core is ready"
              break
            fi
            echo "Waiting... (attempt $i/30)"
            sleep 2
          done

      - name: Setup Bitcoin Core wallet
        run: |
          # Create wallet and generate initial blocks for funds
          curl -s --user sanctuary:sanctuary-verify \
            --data-binary '{"jsonrpc":"1.0","method":"createwallet","params":["test"]}' \
            http://localhost:18443/

          # Get new address and mine 101 blocks to it
          ADDRESS=$(curl -s --user sanctuary:sanctuary-verify \
            --data-binary '{"jsonrpc":"1.0","method":"getnewaddress","params":[]}' \
            http://localhost:18443/ | jq -r '.result')

          curl -s --user sanctuary:sanctuary-verify \
            --data-binary "{\"jsonrpc\":\"1.0\",\"method\":\"generatetoaddress\",\"params\":[101,\"$ADDRESS\"]}" \
            http://localhost:18443/

          echo "Generated 101 blocks to $ADDRESS"

      - name: Install PSBT verification dependencies
        working-directory: scripts/verify-psbt
        run: npm install

      - name: Generate PSBT vectors
        working-directory: scripts/verify-psbt
        run: npx tsx generate-vectors.ts

      - name: Check for PSBT vector changes
        run: |
          if git diff --quiet server/tests/fixtures/generated-psbt-vectors.ts 2>/dev/null; then
            echo "âœ… PSBT vectors unchanged"
          else
            echo "ğŸ“ PSBT vectors updated"
            git diff server/tests/fixtures/generated-psbt-vectors.ts || true
          fi

      - name: Run PSBT tests with new vectors
        working-directory: server
        run: |
          npm ci
          npm run test -- tests/unit/services/bitcoin/psbt.verified.test.ts

  # Summary job
  summary:
    needs: [verify-vectors]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check results
        run: |
          if [ "${{ needs.verify-vectors.result }}" == "success" ]; then
            echo "âœ… All address verification tests passed"
          else
            echo "âŒ Address verification tests failed"
            exit 1
          fi
