# GitLab CI/CD Pipeline for Sanctuary
# Equivalent to GitHub Actions workflows: test.yml, docker-build.yml, install-test.yml,
# release-candidate.yml, create-release.yml, release.yml

stages:
  - test
  - build-check
  - install-test
  - build
  - manifest
  - release

variables:
  NODE_VERSION: "20"
  HTTPS_PORT: "8443"
  HTTP_PORT: "8080"
  REGISTRY: registry.gitlab.com
  IMAGE_PREFIX: $CI_PROJECT_PATH
  # Docker-in-Docker settings
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_TLS_VERIFY: 1
  DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"

# ===========================================
# Templates
# ===========================================
.docker_template:
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - apk add --no-cache bash curl git jq openssl
    - docker info

.node_template:
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm ci
  cache:
    key: ${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - .npm/

# ===========================================
# Test Stage
# ===========================================
backend-tests:
  stage: test
  image: node:${NODE_VERSION}-alpine
  services:
    - name: postgres:16-alpine
      alias: postgres
      variables:
        POSTGRES_USER: test
        POSTGRES_PASSWORD: test
        POSTGRES_DB: sanctuary_test
  variables:
    DATABASE_URL: postgresql://test:test@postgres:5432/sanctuary_test?schema=public
    JWT_SECRET: test-jwt-secret-for-ci-minimum-32-chars
    ENCRYPTION_KEY: test-encryption-key-32-chars-long!
    NODE_ENV: test
  before_script:
    - cd server
    - npm ci
    - npx prisma generate
    - npx prisma migrate deploy
  script:
    - npm run test:unit -- --ci --coverage --forceExit
    - npm run test:integration -- --ci
  artifacts:
    when: always
    paths:
      - server/coverage/
      - server/junit.xml
    expire_in: 14 days
    reports:
      junit: server/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: server/coverage/cobertura-coverage.xml
  cache:
    key: backend-${CI_COMMIT_REF_SLUG}
    paths:
      - server/node_modules/
      - server/.npm/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - src/**/*
        - components/**/*
        - hooks/**/*
        - utils/**/*
        - shared/**/*
        - tests/**/*
        - server/src/**/*
        - server/tests/**/*
        - gateway/src/**/*
        - package*.json
        - server/package*.json
        - vitest.config.ts
        - server/jest.config.js
        - .gitlab-ci.yml
    - if: $CI_COMMIT_TAG
    - when: manual
      allow_failure: true

frontend-tests:
  stage: test
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm ci
  script:
    - npm run test:run -- --coverage
  artifacts:
    when: always
    paths:
      - coverage/
    expire_in: 14 days
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
  cache:
    key: frontend-${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - .npm/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - src/**/*
        - components/**/*
        - hooks/**/*
        - utils/**/*
        - shared/**/*
        - tests/**/*
        - package*.json
        - vitest.config.ts
        - .gitlab-ci.yml
    - if: $CI_COMMIT_TAG
    - when: manual
      allow_failure: true

# ===========================================
# Build Check Stage
# ===========================================
build-frontend:
  stage: build-check
  image: node:${NODE_VERSION}-alpine
  needs:
    - job: frontend-tests
      optional: true
    - job: backend-tests
      optional: true
  before_script:
    - npm ci
  script:
    - npm run build
  cache:
    key: frontend-build-${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

build-backend:
  stage: build-check
  image: node:${NODE_VERSION}-alpine
  needs:
    - job: frontend-tests
      optional: true
    - job: backend-tests
      optional: true
  before_script:
    - cd server
    - npm ci
    - npx prisma generate
  script:
    - npm run build
  cache:
    key: backend-build-${CI_COMMIT_REF_SLUG}
    paths:
      - server/node_modules/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# ===========================================
# Install Test Stage
# ===========================================
install-unit-tests:
  stage: install-test
  extends: .docker_template
  script:
    - chmod +x tests/install/unit/*.sh tests/install/e2e/*.sh tests/install/utils/*.sh
    - ./tests/install/unit/install-script.test.sh
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - install.sh
        - docker-compose.yml
        - Dockerfile
        - server/Dockerfile
        - server/prisma/**/*
        - docker/**/*
        - tests/install/**/*
        - .gitlab-ci.yml
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - install.sh
        - docker-compose.yml
        - Dockerfile
        - server/Dockerfile
        - server/prisma/**/*
        - docker/**/*
        - tests/install/**/*
    - when: manual
      allow_failure: true

fresh-install-test:
  stage: install-test
  extends: .docker_template
  timeout: 30 minutes
  script:
    - chmod +x tests/install/unit/*.sh tests/install/e2e/*.sh tests/install/utils/*.sh
    - ./tests/install/e2e/fresh-install.test.sh --verbose
  after_script:
    - docker compose down -v --remove-orphans || true
    - docker system prune -f || true
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - install.sh
        - docker-compose.yml
        - Dockerfile
        - server/Dockerfile
        - server/prisma/**/*
        - docker/**/*
        - tests/install/**/*
        - .gitlab-ci.yml
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - install.sh
        - docker-compose.yml
        - Dockerfile
        - server/Dockerfile
        - server/prisma/**/*
        - docker/**/*
        - tests/install/**/*
    - when: manual
      allow_failure: true

install-script-test:
  stage: install-test
  extends: .docker_template
  timeout: 30 minutes
  script:
    - chmod +x tests/install/unit/*.sh tests/install/e2e/*.sh tests/install/utils/*.sh install.sh
    - ./tests/install/e2e/install-script.test.sh --verbose
  after_script:
    - docker compose down -v --remove-orphans || true
    - docker system prune -f || true
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - install.sh
        - docker-compose.yml
        - Dockerfile
        - server/Dockerfile
        - server/prisma/**/*
        - docker/**/*
        - tests/install/**/*
    - when: manual
      allow_failure: true

container-health-test:
  stage: install-test
  extends: .docker_template
  timeout: 15 minutes
  needs:
    - job: fresh-install-test
      optional: true
  script:
    - chmod +x tests/install/unit/*.sh tests/install/e2e/*.sh tests/install/utils/*.sh
    # Generate secrets
    - JWT_SECRET=$(openssl rand -base64 32 | tr -d '=/+' | head -c 48)
    - ENCRYPTION_KEY=$(openssl rand -base64 32 | tr -d '=/+' | head -c 48)
    - GATEWAY_SECRET=$(openssl rand -base64 32 | tr -d '=/+' | head -c 48)
    - POSTGRES_PASSWORD=$(openssl rand -base64 16 | tr -d '=/+' | head -c 24)
    # Generate SSL certs
    - cd docker/nginx/ssl && ./generate-certs.sh localhost && cd ../../..
    # Start containers
    - |
      JWT_SECRET="$JWT_SECRET" ENCRYPTION_KEY="$ENCRYPTION_KEY" \
        GATEWAY_SECRET="$GATEWAY_SECRET" POSTGRES_PASSWORD="$POSTGRES_PASSWORD" \
        HTTPS_PORT=$HTTPS_PORT HTTP_PORT=$HTTP_PORT \
        docker compose up -d --build
    - sleep 30
    - ./tests/install/e2e/container-health.test.sh --verbose
  after_script:
    - docker compose down -v --remove-orphans || true
  allow_failure: true
  rules:
    - if: $CI_COMMIT_TAG
    - when: manual
      allow_failure: true

auth-flow-test:
  stage: install-test
  extends: .docker_template
  timeout: 15 minutes
  needs:
    - job: fresh-install-test
      optional: true
  script:
    - chmod +x tests/install/unit/*.sh tests/install/e2e/*.sh tests/install/utils/*.sh
    # Generate secrets
    - JWT_SECRET=$(openssl rand -base64 32 | tr -d '=/+' | head -c 48)
    - ENCRYPTION_KEY=$(openssl rand -base64 32 | tr -d '=/+' | head -c 48)
    - GATEWAY_SECRET=$(openssl rand -base64 32 | tr -d '=/+' | head -c 48)
    - POSTGRES_PASSWORD=$(openssl rand -base64 16 | tr -d '=/+' | head -c 24)
    # Generate SSL certs
    - cd docker/nginx/ssl && ./generate-certs.sh localhost && cd ../../..
    # Start containers with higher rate limits
    - |
      JWT_SECRET="$JWT_SECRET" ENCRYPTION_KEY="$ENCRYPTION_KEY" \
        GATEWAY_SECRET="$GATEWAY_SECRET" POSTGRES_PASSWORD="$POSTGRES_PASSWORD" \
        HTTPS_PORT=$HTTPS_PORT HTTP_PORT=$HTTP_PORT \
        LOGIN_RATE_LIMIT=100 PASSWORD_CHANGE_RATE_LIMIT=100 \
        docker compose up -d --build
    # Wait for migration
    - |
      for i in $(seq 1 60); do
        STATUS=$(docker compose ps migrate --format "{{.Status}}" 2>/dev/null | grep -oE '^[A-Za-z]+' || echo "not_found")
        if [ "$STATUS" = "Exited" ]; then
          break
        fi
        echo "Waiting for migration... (attempt $i/60)"
        sleep 5
      done
    - sleep 30
    - ./tests/install/e2e/auth-flow.test.sh --verbose
  after_script:
    - docker compose down -v --remove-orphans || true
  allow_failure: true
  rules:
    - if: $CI_COMMIT_TAG
    - when: manual
      allow_failure: true

upgrade-test:
  stage: install-test
  extends: .docker_template
  timeout: 45 minutes
  script:
    - chmod +x tests/install/unit/*.sh tests/install/e2e/*.sh tests/install/utils/*.sh
    - ./tests/install/e2e/upgrade-install.test.sh --verbose
  after_script:
    - docker compose down -v --remove-orphans || true
  allow_failure: true
  rules:
    - if: $CI_COMMIT_TAG
    - when: manual
      allow_failure: true

# ===========================================
# Docker Build Stage - Dev Images (main branch)
# ===========================================
build-dev-frontend:
  stage: build
  extends: .docker_template
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - |
      docker build \
        --tag $CI_REGISTRY_IMAGE/frontend:main \
        --tag $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA \
        --file ./Dockerfile \
        .
    - docker push $CI_REGISTRY_IMAGE/frontend:main
    - docker push $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - components/**/*
        - src/**/*
        - utils/**/*
        - shared/**/*
        - docker/**/*
        - Dockerfile
        - docker-compose.yml
        - package*.json
        - .gitlab-ci.yml

build-dev-backend:
  stage: build
  extends: .docker_template
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - |
      docker build \
        --tag $CI_REGISTRY_IMAGE/backend:main \
        --tag $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA \
        --file ./server/Dockerfile \
        .
    - docker push $CI_REGISTRY_IMAGE/backend:main
    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - server/**/*
        - shared/**/*
        - docker/**/*
        - Dockerfile
        - docker-compose.yml
        - package*.json
        - .gitlab-ci.yml

# ===========================================
# Docker Build Stage - Release Images (tags)
# ===========================================
.release_build_template:
  stage: build
  extends: .docker_template
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/

build-release-frontend-amd64:
  extends: .release_build_template
  tags:
    - amd64
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - |
      docker build \
        --platform linux/amd64 \
        --tag $CI_REGISTRY_IMAGE/frontend:${CI_COMMIT_TAG}-linux-amd64 \
        --file ./Dockerfile \
        .
    - docker push $CI_REGISTRY_IMAGE/frontend:${CI_COMMIT_TAG}-linux-amd64

build-release-frontend-arm64:
  extends: .release_build_template
  tags:
    - arm64
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - |
      docker build \
        --platform linux/arm64 \
        --tag $CI_REGISTRY_IMAGE/frontend:${CI_COMMIT_TAG}-linux-arm64 \
        --file ./Dockerfile \
        .
    - docker push $CI_REGISTRY_IMAGE/frontend:${CI_COMMIT_TAG}-linux-arm64

build-release-backend-amd64:
  extends: .release_build_template
  tags:
    - amd64
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - |
      docker build \
        --platform linux/amd64 \
        --tag $CI_REGISTRY_IMAGE/backend:${CI_COMMIT_TAG}-linux-amd64 \
        --file ./server/Dockerfile \
        .
    - docker push $CI_REGISTRY_IMAGE/backend:${CI_COMMIT_TAG}-linux-amd64

build-release-backend-arm64:
  extends: .release_build_template
  tags:
    - arm64
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - |
      docker build \
        --platform linux/arm64 \
        --tag $CI_REGISTRY_IMAGE/backend:${CI_COMMIT_TAG}-linux-arm64 \
        --file ./server/Dockerfile \
        .
    - docker push $CI_REGISTRY_IMAGE/backend:${CI_COMMIT_TAG}-linux-arm64

# ===========================================
# Manifest Stage - Multi-arch manifests
# ===========================================
create-manifests:
  stage: manifest
  extends: .docker_template
  needs:
    - build-release-frontend-amd64
    - build-release-frontend-arm64
    - build-release-backend-amd64
    - build-release-backend-arm64
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - VERSION=${CI_COMMIT_TAG#v}
    # Create frontend manifest
    - |
      docker manifest create $CI_REGISTRY_IMAGE/frontend:${CI_COMMIT_TAG} \
        $CI_REGISTRY_IMAGE/frontend:${CI_COMMIT_TAG}-linux-amd64 \
        $CI_REGISTRY_IMAGE/frontend:${CI_COMMIT_TAG}-linux-arm64
    - docker manifest push $CI_REGISTRY_IMAGE/frontend:${CI_COMMIT_TAG}
    # Create backend manifest
    - |
      docker manifest create $CI_REGISTRY_IMAGE/backend:${CI_COMMIT_TAG} \
        $CI_REGISTRY_IMAGE/backend:${CI_COMMIT_TAG}-linux-amd64 \
        $CI_REGISTRY_IMAGE/backend:${CI_COMMIT_TAG}-linux-arm64
    - docker manifest push $CI_REGISTRY_IMAGE/backend:${CI_COMMIT_TAG}
    # Update :latest for stable releases
    - |
      if [[ "$VERSION" != *-rc* && "$VERSION" != *-alpha* && "$VERSION" != *-beta* ]]; then
        docker manifest create $CI_REGISTRY_IMAGE/frontend:latest \
          $CI_REGISTRY_IMAGE/frontend:${CI_COMMIT_TAG}-linux-amd64 \
          $CI_REGISTRY_IMAGE/frontend:${CI_COMMIT_TAG}-linux-arm64
        docker manifest push $CI_REGISTRY_IMAGE/frontend:latest

        docker manifest create $CI_REGISTRY_IMAGE/backend:latest \
          $CI_REGISTRY_IMAGE/backend:${CI_COMMIT_TAG}-linux-amd64 \
          $CI_REGISTRY_IMAGE/backend:${CI_COMMIT_TAG}-linux-arm64
        docker manifest push $CI_REGISTRY_IMAGE/backend:latest

        echo "Updated :latest tags"
      fi
    # Save digests for release notes
    - |
      FRONTEND_DIGEST=$(docker manifest inspect $CI_REGISTRY_IMAGE/frontend:${CI_COMMIT_TAG} -v | jq -r '.Descriptor.digest')
      BACKEND_DIGEST=$(docker manifest inspect $CI_REGISTRY_IMAGE/backend:${CI_COMMIT_TAG} -v | jq -r '.Descriptor.digest')
      echo "FRONTEND_DIGEST=$FRONTEND_DIGEST" >> build.env
      echo "BACKEND_DIGEST=$BACKEND_DIGEST" >> build.env
      echo "VERSION=$VERSION" >> build.env
  artifacts:
    reports:
      dotenv: build.env
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/

# ===========================================
# Release Stage
# ===========================================
create-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: create-manifests
      artifacts: true
  script:
    - echo "Creating release for ${CI_COMMIT_TAG}"
    - |
      # Get previous tag for changelog
      PREV_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | grep -v "${CI_COMMIT_TAG}" | head -1)

      # Generate changelog
      if [ -n "$PREV_TAG" ]; then
        CHANGELOG=$(git log --pretty=format:"- %s" "$PREV_TAG..$CI_COMMIT_TAG" | head -50)
      else
        CHANGELOG="Initial release"
      fi

      echo "$CHANGELOG" > changelog.md
  release:
    tag_name: $CI_COMMIT_TAG
    name: $CI_COMMIT_TAG
    description: |
      ## Quick Install

      **Prerequisites:** Docker and Docker Compose

      ```bash
      git clone https://gitlab.com/${CI_PROJECT_PATH}.git
      cd sanctuary
      ./install.sh
      ```

      Open **https://localhost:8443** and log in with:
      - **Username:** `admin`
      - **Password:** `sanctuary`

      > Change these credentials immediately after first login.

      ---

      ## Upgrading

      Your data and configuration will be preserved automatically.

      ```bash
      cd sanctuary
      git pull
      ./install.sh
      ```

      ---

      ## Docker Images

      - Frontend: `${CI_REGISTRY_IMAGE}/frontend:${CI_COMMIT_TAG}`
      - Backend: `${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_TAG}`

      ---

      ## Changes

      See commit history for details.
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/

# Update Umbrel package (requires write access to repo)
update-umbrel:
  stage: release
  image: alpine:latest
  needs:
    - job: create-manifests
      artifacts: true
  before_script:
    - apk add --no-cache git curl sed
  script:
    - |
      # Skip for pre-release versions
      if [[ "$VERSION" == *-rc* || "$VERSION" == *-alpha* || "$VERSION" == *-beta* ]]; then
        echo "Skipping Umbrel update for pre-release version: $VERSION"
        exit 0
      fi

      echo "Updating Umbrel package to v$VERSION"

      # Configure git
      git config user.name "GitLab CI"
      git config user.email "gitlab-ci@${CI_SERVER_HOST}"

      # Update umbrel-app.yml version
      sed -i "s/^version: .*/version: \"$VERSION\"/" sanctuary/umbrel-app.yml

      # Update releaseNotes
      RELEASE_DATE=$(date +"%Y-%m-%d")
      sed -i "s/^releaseNotes: .*/releaseNotes: \"Version $VERSION released on $RELEASE_DATE. See https:\/\/gitlab.com\/${CI_PROJECT_PATH}\/-\/releases\/v$VERSION for details.\"/" sanctuary/umbrel-app.yml

      # Update docker-compose.yml with new image tags
      sed -i "s|ghcr.io/n-narusegawa/sanctuary-frontend:[^[:space:]]*|${CI_REGISTRY_IMAGE}/frontend:v$VERSION@$FRONTEND_DIGEST|g" sanctuary/docker-compose.yml
      sed -i "s|ghcr.io/n-narusegawa/sanctuary-backend:[^[:space:]]*|${CI_REGISTRY_IMAGE}/backend:v$VERSION@$BACKEND_DIGEST|g" sanctuary/docker-compose.yml

      # Also handle GitLab registry URLs if they exist
      sed -i "s|${CI_REGISTRY_IMAGE}/frontend:[^[:space:]]*|${CI_REGISTRY_IMAGE}/frontend:v$VERSION@$FRONTEND_DIGEST|g" sanctuary/docker-compose.yml
      sed -i "s|${CI_REGISTRY_IMAGE}/backend:[^[:space:]]*|${CI_REGISTRY_IMAGE}/backend:v$VERSION@$BACKEND_DIGEST|g" sanctuary/docker-compose.yml

      echo "Updated files:"
      grep -E "version:|releaseNotes:" sanctuary/umbrel-app.yml
      grep "image:" sanctuary/docker-compose.yml

      # Commit and push
      git add sanctuary/
      git diff --staged --quiet || git commit -m "Update Umbrel package to v$VERSION

      - Updated Docker image tags with SHA256 digests
      - Updated release notes

      ðŸ¤– Automated release update [skip ci]"

      # Push using CI token
      git push "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" HEAD:main
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/
  allow_failure: true

# ===========================================
# Pipeline Summary
# ===========================================
test-summary:
  stage: release
  image: alpine:latest
  needs:
    - job: backend-tests
      optional: true
    - job: frontend-tests
      optional: true
    - job: build-frontend
      optional: true
    - job: build-backend
      optional: true
  script:
    - echo "Pipeline completed"
    - echo "Backend tests - ${CI_JOB_STATUS:-unknown}"
    - echo "Frontend tests - ${CI_JOB_STATUS:-unknown}"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
  when: always
