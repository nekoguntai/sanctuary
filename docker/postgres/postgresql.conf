# ==========================================================
# PostgreSQL Performance Configuration for Sanctuary
# ==========================================================
# Optimized for 1GB container memory allocation
#
# This file is mounted into the PostgreSQL container at runtime.
# Changes require container restart: ./start.sh --rebuild
# ==========================================================

# --------------------------------------
# MEMORY SETTINGS
# --------------------------------------
# Shared buffers: PostgreSQL's main memory pool for caching data
# Recommended: 25% of available RAM (250MB for 1GB container)
shared_buffers = 256MB

# Effective cache size: Hint to query planner about OS disk cache
# Set to 75% of available RAM for query planning decisions
effective_cache_size = 768MB

# Work memory: Memory for sorting, joins, hash tables per operation
# Each query can use multiple work_mem allocations
# Keep moderate to avoid memory exhaustion with concurrent queries
work_mem = 16MB

# Maintenance work memory: Memory for VACUUM, CREATE INDEX, ALTER TABLE
maintenance_work_mem = 128MB

# --------------------------------------
# WRITE-AHEAD LOG (WAL)
# --------------------------------------
# WAL buffers: Memory for WAL records before writing to disk
wal_buffers = 16MB

# Checkpoint target: Spread checkpoint writes to reduce I/O spikes
checkpoint_completion_target = 0.9

# Minimum WAL size (in 16MB segments)
min_wal_size = 256MB
max_wal_size = 1GB

# --------------------------------------
# QUERY PLANNING
# --------------------------------------
# Random page cost: Lower for SSD storage (Docker volumes typically SSD)
random_page_cost = 1.1

# Effective I/O concurrency: Higher for SSD
effective_io_concurrency = 200

# Default statistics target: Higher = more accurate plans, slower ANALYZE
default_statistics_target = 100

# --------------------------------------
# CONNECTIONS
# --------------------------------------
# Max connections: Matches Prisma pool size + buffer for admin
max_connections = 30

# --------------------------------------
# LOGGING FOR DIAGNOSTICS
# --------------------------------------
# Log slow queries (over 1 second)
log_min_duration_statement = 1000

# Log format for easier parsing
log_line_prefix = '%t [%p-%l] %q%u@%d '

# Log checkpoint activity
log_checkpoints = on

# Log lock waits over 1 second
log_lock_waits = on
deadlock_timeout = 1s

# Log temporary file creation (indicates work_mem may need increase)
log_temp_files = 0

# --------------------------------------
# AUTOVACUUM TUNING
# --------------------------------------
# More aggressive autovacuum for heavily-updated tables
autovacuum_vacuum_scale_factor = 0.05
autovacuum_analyze_scale_factor = 0.025
autovacuum_max_workers = 3
autovacuum_naptime = 30s
