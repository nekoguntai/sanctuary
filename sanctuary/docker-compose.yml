# Sanctuary - Umbrel App
# https://github.com/nekoguntai/sanctuary

services:
  app_proxy:
    environment:
      APP_HOST: sanctuary_web_1
      APP_PORT: 80
      PROXY_AUTH_ADD: "false"

  web:
    image: ghcr.io/nekoguntai/sanctuary-frontend:v0.8.8@sha256:819c5690ab69d838a315e6bb7166345e960c12eb341f945247e6bfb6ba46bb69
    restart: on-failure
    stop_grace_period: 1m
    depends_on:
      server:
        condition: service_healthy
    environment:
      BACKEND_HOST: sanctuary_server_1
      BACKEND_PORT: 3001
      ENABLE_SSL: "false"
    networks:
      default:
        ipv4_address: $APP_SANCTUARY_WEB_IP

  server:
    image: ghcr.io/nekoguntai/sanctuary-backend:v0.8.8@sha256:1085eb5f2869858ab9586cc9b9f53cfda000f008f809a8d04769ae9ad0e65a8e
    restart: on-failure
    stop_grace_period: 1m
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      worker:
        condition: service_healthy
    environment:
      NODE_ENV: production
      PORT: 3001
      LOG_LEVEL: info
      # Database
      DATABASE_URL: postgresql://sanctuary:sanctuary@sanctuary_db_1:5432/sanctuary?schema=public
      # Redis (required)
      REDIS_URL: redis://sanctuary_redis_1:6379
      # JWT - generated per installation
      JWT_SECRET: ${APP_SANCTUARY_JWT_SECRET}
      JWT_EXPIRES_IN: 7d
      # Encryption key for sensitive data
      ENCRYPTION_KEY: ${APP_SANCTUARY_ENCRYPTION_KEY}
      ENCRYPTION_SALT: ${APP_SANCTUARY_ENCRYPTION_SALT}
      GATEWAY_SECRET: ${APP_SANCTUARY_GATEWAY_SECRET}
      WORKER_HEALTH_URL: http://sanctuary_worker_1:3002/health
      # Bitcoin Network
      BITCOIN_NETWORK: mainnet
      # Electrum - connect to Umbrel's electrs
      ELECTRUM_HOST: ${APP_ELECTRS_NODE_IP}
      ELECTRUM_PORT: ${APP_ELECTRS_NODE_PORT}
      ELECTRUM_PROTOCOL: tcp
      # Price APIs (public)
      MEMPOOL_API: https://mempool.space/api/v1
      COINGECKO_API: https://api.coingecko.com/api/v3
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      default:
        ipv4_address: $APP_SANCTUARY_SERVER_IP

  db:
    image: postgres:16-alpine
    restart: on-failure
    stop_grace_period: 1m
    environment:
      POSTGRES_USER: sanctuary
      POSTGRES_PASSWORD: sanctuary
      POSTGRES_DB: sanctuary
    volumes:
      - ${APP_DATA_DIR}/postgresql:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sanctuary -d sanctuary"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      default:
        ipv4_address: $APP_SANCTUARY_DB_IP

  redis:
    image: redis:7-alpine
    restart: on-failure
    stop_grace_period: 1m
    command: redis-server --appendonly yes
    volumes:
      - ${APP_DATA_DIR}/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      default:
        ipv4_address: $APP_SANCTUARY_REDIS_IP

  worker:
    image: ghcr.io/nekoguntai/sanctuary-backend:v0.8.8@sha256:1085eb5f2869858ab9586cc9b9f53cfda000f008f809a8d04769ae9ad0e65a8e
    restart: on-failure
    stop_grace_period: 1m
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      NODE_ENV: production
      LOG_LEVEL: info
      DATABASE_URL: postgresql://sanctuary:sanctuary@sanctuary_db_1:5432/sanctuary?schema=public
      REDIS_URL: redis://sanctuary_redis_1:6379
      WORKER_HEALTH_PORT: 3002
      WORKER_CONCURRENCY: 5
      BITCOIN_NETWORK: mainnet
      ELECTRUM_HOST: ${APP_ELECTRS_NODE_IP}
      ELECTRUM_PORT: ${APP_ELECTRS_NODE_PORT}
      ELECTRUM_PROTOCOL: tcp
      JWT_SECRET: ${APP_SANCTUARY_JWT_SECRET}
      ENCRYPTION_KEY: ${APP_SANCTUARY_ENCRYPTION_KEY}
      ENCRYPTION_SALT: ${APP_SANCTUARY_ENCRYPTION_SALT}
      GATEWAY_SECRET: ${APP_SANCTUARY_GATEWAY_SECRET}
    command: ["node", "dist/app/src/worker.js"]
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      default:
        ipv4_address: $APP_SANCTUARY_WORKER_IP

  migrate:
    image: ghcr.io/nekoguntai/sanctuary-backend:v0.8.8@sha256:1085eb5f2869858ab9586cc9b9f53cfda000f008f809a8d04769ae9ad0e65a8e
    restart: "no"
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://sanctuary:sanctuary@sanctuary_db_1:5432/sanctuary?schema=public
    command: ["sh", "-c", "npx prisma migrate deploy && npx prisma db seed"]
    networks:
      default:
        ipv4_address: $APP_SANCTUARY_MIGRATE_IP
