# Sanctuary - Umbrel App
# https://github.com/n-narusegawa/sanctuary

services:
  app_proxy:
    environment:
      APP_HOST: sanctuary_web_1
      APP_PORT: 80
      PROXY_AUTH_ADD: "false"

  web:
    image: ghcr.io/n-narusegawa/sanctuary-frontend:v0.7.14@sha256:76e3758f63afcf01e8aa8fb2b2ceddf4994e79fe92d7ab7d15b17c3e4d906acf
    restart: on-failure
    stop_grace_period: 1m
    depends_on:
      - server
    environment:
      BACKEND_HOST: sanctuary_server_1
      BACKEND_PORT: 3001
      ENABLE_SSL: "false"
    networks:
      default:
        ipv4_address: $APP_SANCTUARY_WEB_IP

  server:
    image: ghcr.io/n-narusegawa/sanctuary-backend:v0.7.14@sha256:a0ab3f4d3d2f4381ee772f646513913891864d177a52125ebc004f001958d4e9
    restart: on-failure
    stop_grace_period: 1m
    depends_on:
      - db
    environment:
      NODE_ENV: production
      PORT: 3001
      LOG_LEVEL: info
      # Database
      DATABASE_URL: postgresql://sanctuary:sanctuary@sanctuary_db_1:5432/sanctuary?schema=public
      # JWT - generated per installation
      JWT_SECRET: ${APP_SANCTUARY_JWT_SECRET}
      JWT_EXPIRES_IN: 7d
      # Encryption key for sensitive data
      ENCRYPTION_KEY: ${APP_SANCTUARY_ENCRYPTION_KEY}
      # Bitcoin Network
      BITCOIN_NETWORK: mainnet
      # Electrum - connect to Umbrel's electrs
      ELECTRUM_HOST: ${APP_ELECTRS_NODE_IP}
      ELECTRUM_PORT: ${APP_ELECTRS_NODE_PORT}
      ELECTRUM_PROTOCOL: tcp
      # Price APIs (public)
      MEMPOOL_API: https://mempool.space/api/v1
      COINGECKO_API: https://api.coingecko.com/api/v3
    networks:
      default:
        ipv4_address: $APP_SANCTUARY_SERVER_IP

  db:
    image: postgres:16-alpine
    restart: on-failure
    stop_grace_period: 1m
    environment:
      POSTGRES_USER: sanctuary
      POSTGRES_PASSWORD: sanctuary
      POSTGRES_DB: sanctuary
    volumes:
      - ${APP_DATA_DIR}/postgresql:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sanctuary -d sanctuary"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      default:
        ipv4_address: $APP_SANCTUARY_DB_IP

  migrate:
    image: ghcr.io/n-narusegawa/sanctuary-backend:v0.7.14@sha256:a0ab3f4d3d2f4381ee772f646513913891864d177a52125ebc004f001958d4e9
    restart: "no"
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://sanctuary:sanctuary@sanctuary_db_1:5432/sanctuary?schema=public
    command: ["sh", "-c", "npx prisma migrate deploy && npx prisma db seed"]
    networks:
      default:
        ipv4_address: $APP_SANCTUARY_MIGRATE_IP
