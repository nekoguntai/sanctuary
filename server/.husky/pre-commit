#!/bin/sh

# =============================================
# Pre-commit Hook - Run Tests Before Commit
# =============================================
# This hook runs fast tests on changed files to catch issues early.
# For full test suite, run: npm run test:all
# =============================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Agent stop flags (set to 1 if agent recommends stopping)
TEST_COVERAGE_STOP=0
UI_CONSISTENCY_STOP=0
ARCHITECTURE_STOP=0

echo "${YELLOW}Running pre-commit checks...${NC}"

# Get the repository root
REPO_ROOT=$(git rev-parse --show-toplevel)

# =============================================
# AI Test Coverage Analysis
# =============================================
# Use Claude to analyze if tests need to be added, updated, or removed

run_test_coverage_agent() {
    # Check if claude is available
    if ! command -v claude >/dev/null 2>&1; then
        echo "${YELLOW}Claude CLI not found, skipping AI test analysis${NC}"
        return 0
    fi

    # Get staged files
    STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx)$' || true)

    if [ -z "$STAGED_FILES" ]; then
        return 0
    fi

    echo ""
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${BLUE}ðŸ¤– AI Test Coverage Analysis${NC}"
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""

    # Get the diff for context
    DIFF_CONTENT=$(git diff --cached)

    # Create the prompt for test coverage analysis
    PROMPT="PRE-COMMIT TEST COVERAGE REVIEW

Analyze these staged changes and determine if tests need to be built, updated, or removed.

STAGED FILES:
$STAGED_FILES

DIFF:
$DIFF_CONTENT

Answer concisely:
1. Do any NEW tests need to be written? If so, what should they test?
2. Do any EXISTING tests need to be updated to match the changes?
3. Should any tests be REMOVED (e.g., testing deleted functionality)?

End with one of:
- âœ… RECOMMEND PROCEED - no test changes needed
- âš ï¸ SUGGEST REVIEW - minor test updates may be helpful
- âŒ RECOMMEND STOP - tests should be updated before committing"

    # Run claude with the qa-test-architect agent
    # Capture output to check for RECOMMEND STOP
    AGENT_OUTPUT=$(echo "$PROMPT" | claude --agent qa-test-architect --print 2>&1) || true
    echo "$AGENT_OUTPUT"

    # Check if agent recommends stopping
    if echo "$AGENT_OUTPUT" | grep -q "RECOMMEND STOP"; then
        echo ""
        echo "${RED}âŒ Test coverage agent recommends stopping. Please address the issues above.${NC}"
        echo "${YELLOW}To bypass: git commit --no-verify${NC}"
        TEST_COVERAGE_STOP=1
    fi

    echo ""
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

# Run AI test coverage analysis
run_test_coverage_agent

# =============================================
# UI Consistency & Style Analysis
# =============================================
# Use Claude to check UI changes fit existing patterns and use shared styles

run_ui_consistency_agent() {
    # Check if claude is available
    if ! command -v claude >/dev/null 2>&1; then
        return 0
    fi

    # Get staged UI files (components, hooks with UI, contexts)
    UI_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^(components/|hooks/|contexts/).*\.tsx$' || true)

    if [ -z "$UI_FILES" ]; then
        return 0
    fi

    echo ""
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${BLUE}ðŸŽ¨ UI Consistency & Style Analysis${NC}"
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""

    # Get the diff for context
    UI_DIFF=$(git diff --cached -- $UI_FILES)

    # Create the prompt for UI consistency analysis
    PROMPT="PRE-COMMIT UI CONSISTENCY REVIEW

Analyze these UI changes for consistency with our existing codebase patterns.

STAGED UI FILES:
$UI_FILES

DIFF:
$UI_DIFF

Our codebase uses:
- Tailwind CSS with custom 'sanctuary' and 'primary' color palettes
- Dark mode support via 'dark:' prefix classes
- Consistent patterns: sanctuary-50 to sanctuary-950, primary-50 to primary-950
- Surface components and shared UI patterns in components/
- Common button styles, card layouts, modal patterns

Answer concisely:
1. Do the changes FIT the existing UI flow and component patterns?
2. Are there ONE-OFF custom styles that should use existing Tailwind classes or shared components instead?
3. Are dark mode styles properly implemented (dark: variants)?
4. Could any new UI be TEMPLATIZED using existing patterns?

End with one of:
- âœ… RECOMMEND PROCEED - UI changes are consistent
- âš ï¸ SUGGEST REVIEW - minor style inconsistencies found
- âŒ RECOMMEND STOP - significant UI pattern violations"

    # Run claude with the ui-architect agent
    # Capture output to check for RECOMMEND STOP
    AGENT_OUTPUT=$(echo "$PROMPT" | claude --agent ui-architect --print 2>&1) || true
    echo "$AGENT_OUTPUT"

    # Check if agent recommends stopping
    if echo "$AGENT_OUTPUT" | grep -q "RECOMMEND STOP"; then
        echo ""
        echo "${RED}âŒ UI consistency agent recommends stopping. Please address the issues above.${NC}"
        echo "${YELLOW}To bypass: git commit --no-verify${NC}"
        UI_CONSISTENCY_STOP=1
    fi

    echo ""
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

# Run UI consistency analysis
run_ui_consistency_agent

# =============================================
# Architecture & Scalability Analysis
# =============================================
# Use Claude to validate scalability, extensibility, and cleanup patterns

run_architecture_agent() {
    # Check if claude is available
    if ! command -v claude >/dev/null 2>&1; then
        return 0
    fi

    # Get staged source files (excluding tests)
    SOURCE_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx)$' | grep -vE '(\.test\.|\.spec\.|/tests/)' || true)

    if [ -z "$SOURCE_FILES" ]; then
        return 0
    fi

    echo ""
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${BLUE}ðŸ—ï¸  Architecture & Scalability Analysis${NC}"
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""

    # Get the diff for context
    ARCH_DIFF=$(git diff --cached -- $SOURCE_FILES)

    # Create the prompt for architecture analysis
    PROMPT="PRE-COMMIT ARCHITECTURE REVIEW

Analyze these changes for scalability, extensibility, and operational robustness.

STAGED SOURCE FILES:
$SOURCE_FILES

DIFF:
$ARCH_DIFF

Our codebase requirements:
- Must run perpetually without memory leaks or resource exhaustion
- Services should have proper cleanup (intervals, subscriptions, connections)
- Code should be extensible without modifying core logic
- Database operations should be transactional where needed
- WebSocket/event handlers must properly clean up on disconnect

Answer concisely:
1. SCALABILITY: Are there any patterns that won't scale (N+1 queries, unbounded arrays, blocking operations)?
2. EXTENSIBILITY: Does the code follow open/closed principle? Can it be extended without modification?
3. CLEANUP: Are intervals, timeouts, subscriptions, and connections properly cleaned up?
4. PERPETUAL OPERATION: Any memory leaks, growing caches, or resources that aren't released?

End with one of:
- âœ… RECOMMEND PROCEED - architecture is sound
- âš ï¸ SUGGEST REVIEW - minor architectural concerns
- âŒ RECOMMEND STOP - significant architectural issues"

    # Run claude with the lead-software-architect agent
    # Capture output to check for RECOMMEND STOP
    AGENT_OUTPUT=$(echo "$PROMPT" | claude --agent lead-software-architect --print 2>&1) || true
    echo "$AGENT_OUTPUT"

    # Check if agent recommends stopping
    if echo "$AGENT_OUTPUT" | grep -q "RECOMMEND STOP"; then
        echo ""
        echo "${RED}âŒ Architecture agent recommends stopping. Please address the issues above.${NC}"
        echo "${YELLOW}To bypass: git commit --no-verify${NC}"
        ARCHITECTURE_STOP=1
    fi

    echo ""
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

# Run architecture analysis
run_architecture_agent

# Check if any agent recommended stopping
if [ "$TEST_COVERAGE_STOP" = "1" ] || [ "$UI_CONSISTENCY_STOP" = "1" ] || [ "$ARCHITECTURE_STOP" = "1" ]; then
    echo ""
    echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${RED}â›” COMMIT BLOCKED - One or more agents recommend stopping${NC}"
    echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "${YELLOW}Please address the issues above before committing.${NC}"
    echo "${YELLOW}To bypass: git commit --no-verify${NC}"
    echo ""
    exit 1
fi

# Check for staged files in different areas
BACKEND_CHANGED=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^server/' || true)
FRONTEND_CHANGED=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^(src/|components/|hooks/|tests/)' || true)

# Timeout for test runs (2 minutes)
TEST_TIMEOUT=120

# Check if Prisma schema changed and regenerate client
SCHEMA_CHANGED=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^server/prisma/schema.prisma$' || true)
if [ -n "$SCHEMA_CHANGED" ]; then
    echo "${YELLOW}Prisma schema changed - regenerating client...${NC}"
    cd "$REPO_ROOT/server"
    npx prisma generate
    echo "${GREEN}Prisma client regenerated${NC}"
fi

# Run backend tests if backend files changed
if [ -n "$BACKEND_CHANGED" ]; then
    echo "${YELLOW}Backend files changed - running server tests...${NC}"
    cd "$REPO_ROOT/server"

    if timeout $TEST_TIMEOUT npm run test:fast 2>/dev/null; then
        echo "${GREEN}Backend tests passed${NC}"
    elif [ $? -eq 124 ]; then
        echo "${RED}Backend tests timed out after ${TEST_TIMEOUT}s. Commit aborted.${NC}"
        exit 1
    else
        echo "${RED}Backend tests failed. Commit aborted.${NC}"
        echo "Run 'cd server && npm test' for full output."
        exit 1
    fi
fi

# Run frontend tests if frontend files changed
if [ -n "$FRONTEND_CHANGED" ]; then
    echo "${YELLOW}Frontend files changed - running frontend tests...${NC}"
    cd "$REPO_ROOT"

    if timeout $TEST_TIMEOUT npm run test:run 2>/dev/null; then
        echo "${GREEN}Frontend tests passed${NC}"
    elif [ $? -eq 124 ]; then
        echo "${RED}Frontend tests timed out after ${TEST_TIMEOUT}s. Commit aborted.${NC}"
        exit 1
    else
        echo "${RED}Frontend tests failed. Commit aborted.${NC}"
        echo "Run 'npm run test:run' for full output."
        exit 1
    fi
fi

# If no relevant files changed, skip tests
if [ -z "$BACKEND_CHANGED" ] && [ -z "$FRONTEND_CHANGED" ]; then
    echo "${GREEN}No test-relevant files changed, skipping tests.${NC}"
fi

echo "${GREEN}Pre-commit checks passed!${NC}"
