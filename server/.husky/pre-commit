#!/bin/sh

# =============================================
# Pre-commit Hook - Run Tests Before Commit
# =============================================
# This hook runs fast tests on changed files to catch issues early.
# For full test suite, run: npm run test:all
# =============================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo "${YELLOW}Running pre-commit checks...${NC}"

# Get the repository root
REPO_ROOT=$(git rev-parse --show-toplevel)

# =============================================
# AI Test Coverage Analysis
# =============================================
# Use Claude to analyze if tests need to be added, updated, or removed

run_test_coverage_agent() {
    # Check if claude is available
    if ! command -v claude >/dev/null 2>&1; then
        echo "${YELLOW}Claude CLI not found, skipping AI test analysis${NC}"
        return 0
    fi

    # Get staged files
    STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx)$' || true)

    if [ -z "$STAGED_FILES" ]; then
        return 0
    fi

    echo ""
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${BLUE}ðŸ¤– AI Test Coverage Analysis${NC}"
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""

    # Get the diff for context
    DIFF_CONTENT=$(git diff --cached)

    # Create the prompt for test coverage analysis
    PROMPT="PRE-COMMIT TEST COVERAGE REVIEW

Analyze these staged changes and determine if tests need to be built, updated, or removed.

STAGED FILES:
$STAGED_FILES

DIFF:
$DIFF_CONTENT

Answer concisely:
1. Do any NEW tests need to be written? If so, what should they test?
2. Do any EXISTING tests need to be updated to match the changes?
3. Should any tests be REMOVED (e.g., testing deleted functionality)?

End with one of:
- âœ… RECOMMEND PROCEED - no test changes needed
- âš ï¸ SUGGEST REVIEW - minor test updates may be helpful
- âŒ RECOMMEND STOP - tests should be updated before committing"

    # Run claude with the qa-test-architect agent
    echo "$PROMPT" | claude --agent qa-test-architect --print 2>/dev/null

    echo ""
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

# Run AI test coverage analysis
run_test_coverage_agent

# Check for staged files in different areas
BACKEND_CHANGED=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^server/' || true)
FRONTEND_CHANGED=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^(src/|components/|hooks/|tests/)' || true)

# Timeout for test runs (2 minutes)
TEST_TIMEOUT=120

# Check if Prisma schema changed and regenerate client
SCHEMA_CHANGED=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^server/prisma/schema.prisma$' || true)
if [ -n "$SCHEMA_CHANGED" ]; then
    echo "${YELLOW}Prisma schema changed - regenerating client...${NC}"
    cd "$REPO_ROOT/server"
    npx prisma generate
    echo "${GREEN}Prisma client regenerated${NC}"
fi

# Run backend tests if backend files changed
if [ -n "$BACKEND_CHANGED" ]; then
    echo "${YELLOW}Backend files changed - running server tests...${NC}"
    cd "$REPO_ROOT/server"

    if timeout $TEST_TIMEOUT npm run test:fast 2>/dev/null; then
        echo "${GREEN}Backend tests passed${NC}"
    elif [ $? -eq 124 ]; then
        echo "${RED}Backend tests timed out after ${TEST_TIMEOUT}s. Commit aborted.${NC}"
        exit 1
    else
        echo "${RED}Backend tests failed. Commit aborted.${NC}"
        echo "Run 'cd server && npm test' for full output."
        exit 1
    fi
fi

# Run frontend tests if frontend files changed
if [ -n "$FRONTEND_CHANGED" ]; then
    echo "${YELLOW}Frontend files changed - running frontend tests...${NC}"
    cd "$REPO_ROOT"

    if timeout $TEST_TIMEOUT npm run test:run 2>/dev/null; then
        echo "${GREEN}Frontend tests passed${NC}"
    elif [ $? -eq 124 ]; then
        echo "${RED}Frontend tests timed out after ${TEST_TIMEOUT}s. Commit aborted.${NC}"
        exit 1
    else
        echo "${RED}Frontend tests failed. Commit aborted.${NC}"
        echo "Run 'npm run test:run' for full output."
        exit 1
    fi
fi

# If no relevant files changed, skip tests
if [ -z "$BACKEND_CHANGED" ] && [ -z "$FRONTEND_CHANGED" ]; then
    echo "${GREEN}No test-relevant files changed, skipping tests.${NC}"
fi

echo "${GREEN}Pre-commit checks passed!${NC}"
