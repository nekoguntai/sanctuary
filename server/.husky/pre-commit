#!/bin/sh

# =============================================
# Pre-commit Hook - Run Tests Before Commit
# =============================================
# This hook runs fast tests on changed files to catch issues early.
# For full test suite, run: npm run test:all
# =============================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo "${YELLOW}Running pre-commit checks...${NC}"

# Get the repository root
REPO_ROOT=$(git rev-parse --show-toplevel)

# =============================================
# Test Coverage Check
# =============================================
# Check if source files have corresponding test updates

check_test_coverage() {
    # Get staged source files (excluding tests themselves)
    SOURCE_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx)$' | grep -vE '(\.test\.|\.spec\.|/tests/)' || true)

    # Get staged test files
    TEST_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '(\.test\.|\.spec\.|/tests/)' || true)

    if [ -z "$SOURCE_FILES" ]; then
        return 0
    fi

    echo ""
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${BLUE}ðŸ“‹ Test Coverage Review${NC}"
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

    MISSING_TESTS=""
    HAS_COMPONENT_CHANGES=false
    HAS_API_CHANGES=false
    HAS_UTIL_CHANGES=false

    for file in $SOURCE_FILES; do
        # Check file type and suggest test location
        case "$file" in
            components/*.tsx)
                HAS_COMPONENT_CHANGES=true
                base=$(basename "$file" .tsx)
                expected_test="tests/components/${base}.test.tsx"
                ;;
            hooks/*.ts|hooks/*.tsx)
                base=$(basename "$file" | sed 's/\.tsx\?$//')
                expected_test="tests/hooks/${base}.test.tsx"
                ;;
            src/api/*.ts)
                HAS_API_CHANGES=true
                base=$(basename "$file" .ts)
                expected_test="server/tests/api/${base}.test.ts"
                ;;
            server/src/services/*.ts)
                base=$(basename "$file" .ts)
                expected_test="server/tests/services/${base}.test.ts"
                ;;
            server/src/api/*.ts)
                HAS_API_CHANGES=true
                base=$(basename "$file" .ts)
                expected_test="server/tests/api/${base}.test.ts"
                ;;
            utils/*.ts)
                HAS_UTIL_CHANGES=true
                base=$(basename "$file" .ts)
                expected_test="tests/utils/${base}.test.ts"
                ;;
            *)
                expected_test=""
                ;;
        esac

        # Check if test file exists and was modified
        if [ -n "$expected_test" ]; then
            if [ ! -f "$REPO_ROOT/$expected_test" ]; then
                MISSING_TESTS="${MISSING_TESTS}  ${YELLOW}âš ${NC}  $file ${RED}(no test file: $expected_test)${NC}\n"
            elif ! echo "$TEST_FILES" | grep -q "$expected_test"; then
                MISSING_TESTS="${MISSING_TESTS}  ${YELLOW}?${NC}  $file ${YELLOW}(test exists but not modified)${NC}\n"
            fi
        fi
    done

    # Show summary
    echo ""
    echo "${BLUE}Source files changed:${NC}"
    for file in $SOURCE_FILES; do
        echo "  â€¢ $file"
    done

    if [ -n "$TEST_FILES" ]; then
        echo ""
        echo "${GREEN}Test files updated:${NC}"
        for file in $TEST_FILES; do
            echo "  âœ“ $file"
        done
    fi

    if [ -n "$MISSING_TESTS" ]; then
        echo ""
        echo "${YELLOW}Potential test gaps:${NC}"
        printf "$MISSING_TESTS"
    fi

    echo ""
    echo "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

    # Interactive prompt (only if terminal is interactive)
    if [ -t 0 ]; then
        echo ""
        echo "${BLUE}Test coverage questions:${NC}"
        echo "  1. Did you add/update tests for new functionality?"
        echo "  2. Did you update existing tests if behavior changed?"
        echo "  3. Should any tests be removed (dead code)?"
        echo ""
        printf "${YELLOW}Continue with commit? [Y/n/q] ${NC}"
        read -r response
        case "$response" in
            [nN])
                echo "${RED}Commit aborted. Please update tests and try again.${NC}"
                exit 1
                ;;
            [qQ])
                echo "${RED}Commit aborted.${NC}"
                exit 1
                ;;
            *)
                echo "${GREEN}Proceeding with commit...${NC}"
                ;;
        esac
    fi

    echo ""
}

# Run test coverage check
check_test_coverage

# Check for staged files in different areas
BACKEND_CHANGED=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^server/' || true)
FRONTEND_CHANGED=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^(src/|components/|hooks/|tests/)' || true)

# Timeout for test runs (2 minutes)
TEST_TIMEOUT=120

# Check if Prisma schema changed and regenerate client
SCHEMA_CHANGED=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^server/prisma/schema.prisma$' || true)
if [ -n "$SCHEMA_CHANGED" ]; then
    echo "${YELLOW}Prisma schema changed - regenerating client...${NC}"
    cd "$REPO_ROOT/server"
    npx prisma generate
    echo "${GREEN}Prisma client regenerated${NC}"
fi

# Run backend tests if backend files changed
if [ -n "$BACKEND_CHANGED" ]; then
    echo "${YELLOW}Backend files changed - running server tests...${NC}"
    cd "$REPO_ROOT/server"

    if timeout $TEST_TIMEOUT npm run test:fast 2>/dev/null; then
        echo "${GREEN}Backend tests passed${NC}"
    elif [ $? -eq 124 ]; then
        echo "${RED}Backend tests timed out after ${TEST_TIMEOUT}s. Commit aborted.${NC}"
        exit 1
    else
        echo "${RED}Backend tests failed. Commit aborted.${NC}"
        echo "Run 'cd server && npm test' for full output."
        exit 1
    fi
fi

# Run frontend tests if frontend files changed
if [ -n "$FRONTEND_CHANGED" ]; then
    echo "${YELLOW}Frontend files changed - running frontend tests...${NC}"
    cd "$REPO_ROOT"

    if timeout $TEST_TIMEOUT npm run test:run 2>/dev/null; then
        echo "${GREEN}Frontend tests passed${NC}"
    elif [ $? -eq 124 ]; then
        echo "${RED}Frontend tests timed out after ${TEST_TIMEOUT}s. Commit aborted.${NC}"
        exit 1
    else
        echo "${RED}Frontend tests failed. Commit aborted.${NC}"
        echo "Run 'npm run test:run' for full output."
        exit 1
    fi
fi

# If no relevant files changed, skip tests
if [ -z "$BACKEND_CHANGED" ] && [ -z "$FRONTEND_CHANGED" ]; then
    echo "${GREEN}No test-relevant files changed, skipping tests.${NC}"
fi

echo "${GREEN}Pre-commit checks passed!${NC}"
